# H√ºrriyet Rehber Haber Store Site Configuration with SSL

# HTTP Server (redirects to HTTPS)
server {
    listen 80;
    server_name h√ºrriyetrehberhaber.store www.h√ºrriyetrehberhaber.store xn--hrriyetrehberhaber-m6b.store www.xn--hrriyetrehberhaber-m6b.store;
    
    # ACME Challenge for Let's Encrypt
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        try_files $uri =404;
    }
    
    # Redirect all HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS Server
server {
    listen 443 ssl http2;
    server_name h√ºrriyetrehberhaber.store www.h√ºrriyetrehberhaber.store xn--hrriyetrehberhaber-m6b.store www.xn--hrriyetrehberhaber-m6b.store;
    
    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/xn--hrriyetrehberhaber-m6b.store/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xn--hrriyetrehberhaber-m6b.store/privkey.pem;
    
    # SSL Security Settings
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozTLS:10m;
    ssl_session_tickets off;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # Main application proxy to port 8080
    location / {
        # ============================================
        # ü§ñ FACEBOOK BOT BYPASS: Allow domain verification
        # ============================================
        set $is_facebook_bot 0;
        if ($http_user_agent ~* "(facebookexternalhit|facebookcatalog|Facebot)") {
            set $is_facebook_bot 1;
        }
        
        # ============================================
        # üõ°Ô∏è RATE LIMITING: 30 requests/minute + 10 burst
        # Note: Facebook bot requests are limited but won't be blocked
        # ============================================
        limit_req zone=pages burst=10 nodelay;
        
        # ============================================
        # üåç GEO-BLOCKING: Turkey + International Facebook Ads
        # Facebook bot bypass - allow domain verification
        # ============================================
        
        # Multi-condition check using string concatenation
        # Format: {country}_{facebook}_{admin}_{debug}_{bot}
        set $geo_check "${allowed_country}_";
        
        # Check Facebook referrer
        set $has_facebook 0;
        if ($http_referer ~* "(facebook\.com|facebook\.net|fb\.com)") {
            set $has_facebook 1;
        }
        if ($arg_fbclid != "") {
            set $has_facebook 1;
        }
        set $geo_check "${geo_check}${has_facebook}_";
        
        # Check admin IP (TEMPORARILY DISABLED FOR TESTING)
        set $is_admin 0;
        # if ($remote_addr = "85.98.16.30") {
        #     set $is_admin 1;
        # }
        # if ($http_x_forwarded_for ~ "85.98.16.30") {
        #     set $is_admin 1;
        # }
        # if ($http_x_real_ip = "85.98.16.30") {
        #     set $is_admin 1;
        # }
        set $geo_check "${geo_check}${is_admin}_";
        
        # Check secure access key (g√ºvenli test/debug eri≈üimi)
        set $is_debug 0;
        if ($arg_access_key = "HUR2024_SecureTest_9K3mP7xQ") {
            set $is_debug 1;
        }
        if ($arg_key = "HUR2024_SecureTest_9K3mP7xQ") {
            set $is_debug 1;
        }
        # ESKƒ∞ DEBUG (Geriye d√∂n√ºk uyumluluk - G√úVENSƒ∞Z!)
        set $geo_check "${geo_check}${is_debug}_";
        
        # Add Facebook bot to geo_check
        set $geo_check "${geo_check}${is_facebook_bot}";
        
        # Evaluate geo-blocking rules
        # 1_*_*_*_* = Turkey (always allowed)
        # 0_1_*_*_* = International with Facebook (allowed)
        # *_*_1_*_* = Admin IP (always allowed)
        # *_*_*_1_* = Debug mode (always allowed)
        # *_*_*_*_1 = Facebook bot (always allowed for verification)
        
        set $geo_allowed 0;
        
        # Facebook bot - HIGHEST PRIORITY (domain verification)
        if ($is_facebook_bot = 1) {
            set $geo_allowed 1;
        }
        
        # Turkey with Facebook (must have fb referrer)
        if ($geo_check ~ "^1_1_") {
            set $geo_allowed 1;
        }
        
        # International with Facebook
        if ($geo_check ~ "^0_1_") {
            set $geo_allowed 1;
        }
        
        # Admin IP
        if ($geo_check ~ "_1_[0-1]_[0-1]$") {
            set $geo_allowed 1;
        }
        
        # Debug mode
        if ($geo_check ~ "_1_[0-1]$") {
            set $geo_allowed 1;
        }
        
        # Block if geo check fails
        if ($geo_allowed = 0) {
            return 403;  # Forbidden - Geo-blocked
        }
        
        # ============================================
        # üîí SECURITY: Mobile-Only Access Control
        # Facebook bot bypass for domain verification
        # ============================================
        
        # Mobile device detection
        set $mobile 0;
        if ($http_user_agent ~* "(Android|iPhone|iPad|iPod|Mobile|webOS|BlackBerry|IEMobile|Opera Mini|FBAN|FBAV|Instagram)") {
            set $mobile 1;
        }
        
        # Admin IP bypass (full access from desktop too)
        if ($is_admin = 1) {
            set $mobile 1;
        }
        
        # Secure access key bypass (?access_key=... veya ?key=...)
        if ($arg_access_key = "HUR2024_SecureTest_9K3mP7xQ") {
            set $mobile 1;
        }
        if ($arg_key = "HUR2024_SecureTest_9K3mP7xQ") {
            set $mobile 1;
        }
        
        # Facebook bot bypass (domain verification)
        if ($is_facebook_bot = 1) {
            set $mobile 1;
        }
        
        # ESKƒ∞ DEBUG (Devre dƒ±≈üƒ± - g√ºvensiz!)
        
        # Block non-mobile devices (except admin IP and Facebook bot)
        if ($mobile = 0) {
            return 404;
        }
        
        # ============================================
        # Referrer Check: Turkey OR Facebook (for ads)
        # ============================================
        
        # Facebook referrer or Click ID check (already handled in geo-blocking)
        set $valid_referrer 0;
        
        
        # International users: already checked in geo-blocking
        if ($geo_allowed = 1) {
            set $valid_referrer 1;
        }
        
        
        # Debug mode bypass (?debug=true)
        
        # Block if referrer check fails (redundant but kept for safety)
        if ($valid_referrer = 0) {
            return 404;
        }
        
        # ============================================
        # Access granted - Proxy to backend
        # ============================================
        
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # Static assets with caching (INCLUDING VIDEO FILES AND WEBP)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf|txt|woff|woff2|ttf|eot|svg|mp4|webm|ogg|avi|mov|webp)$ {
        # Rate limiting: 100 requests/minute + 50 burst for static files
        limit_req zone=static burst=50 nodelay;
        
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # ULTRA AGGRESSIVE CACHING RE-ENABLED
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "nginx-hurriyet-ssl-ultra";
        
        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_comp_level 6;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    }
    
    # Form submission endpoint (strict rate limiting)
    location /submit-order {
        # Rate limiting: 5 requests/minute + 2 burst (prevent spam)
        limit_req zone=forms burst=2 nodelay;
        
        proxy_pass http://127.0.0.1:8080/submit-order;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
    
    # API endpoints (medium rate limiting)
    location /api/ {
        # Rate limiting: 10 requests/minute + 3 burst
        limit_req zone=api burst=3 nodelay;
        
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
    
    # Health check endpoint
    location /health {
        proxy_pass http://127.0.0.1:8080/health;
        proxy_set_header Host $host;
        access_log off;
    }
    
    # Logs
    access_log /var/log/nginx-hurriyet/hurriyetrehberhaber-store-ssl.access.log;
    error_log /var/log/nginx-hurriyet/hurriyetrehberhaber-store-ssl.error.log;
}
